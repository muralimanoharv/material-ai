name: Lint, Test, and Report

on:
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  pull-requests: write # <--- REQUIRED to post the comment

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install dependencies with uv
        run: |
          pip install uv
          uv pip install --system .[dev]

      - name: Check Code Formatting
        run: black --check .

      - name: Run tests and generate reports
        env:
          CONFIG_PATH: config.ini
        run: |
          pytest --cov=./ \
                 --cov-report=term \
                 --cov-report=html \
                 --cov-fail-under=90 \
                 --junitxml=pytest.xml | tee coverage-summary.txt

      - name: Upload Test Results
        id: upload-artifact # <--- Give this an ID (optional, but good practice)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            pytest.xml
            coverage-summary.txt
            htmlcov/
          retention-days: 5

      # NEW: Post a clean link to the artifacts
      - name: Comment Report Link on PR
        uses: actions/github-script@v7
        if: always() # Run even if tests fail
        with:
          script: |
            // 1. Construct the URL to the Workflow Run
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            
            // 2. Create the comment body
            const body = `### ðŸ“Š Test Results Available
            
            The HTML Coverage report and test logs have been generated.
            
            ðŸ“¥ **[Download Report from Actions Summary](${runUrl})**
            
            *(Navigate to the **Artifacts** section at the bottom of the page)*`;

            // 3. Post the comment
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });