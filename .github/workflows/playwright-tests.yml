name: Playwright E2E Tests

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

# 1. NEW: Required permission to allow the bot to comment on PRs
permissions:
  contents: read
  pull-requests: write

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest

    env:
      UV_CACHE_DIR: /tmp/.uv-cache

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # --- 1. SETUP UV & PYTHON ---
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
          enable-cache: true
          cache-suffix: "backend-deps"

      - name: Set up Python
        run: uv python install 3.13

      # --- 2. INSTALL DEPENDENCIES ---
      - name: Install Project Dependencies
        run: uv sync --frozen || uv sync

      # --- 3. ACTIVATE ENVIRONMENT ---
      - name: Add .venv to PATH
        run: echo "$GITHUB_WORKSPACE/.venv/bin" >> $GITHUB_PATH

      # --- 4. FRONTEND SETUP ---
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ./src/material_ai/ui/package-lock.json

      - name: Install Node dependencies
        working-directory: ./src/material_ai/ui
        run: npm ci

      - name: Install Playwright Browsers
        working-directory: ./src/material_ai/ui
        run: npx playwright install --with-deps chromium

      # --- 5. RUN TESTS ---
      - name: Run Playwright tests
        working-directory: ./src/material_ai/ui
        run: npx playwright test --project=chromium
        env:
          CI: true
          SSO_CLIENT_ID: ${{ secrets.SSO_CLIENT_ID }}
          SSO_CLIENT_SECRET: ${{ secrets.SSO_CLIENT_SECRET }}
          SSO_REDIRECT_URI: ${{ secrets.SSO_REDIRECT_URI }}
          SSO_SESSION_SECRET_KEY: ${{ secrets.SSO_SESSION_SECRET_KEY }}
          CONFIG_PATH: ${{ secrets.CONFIG_PATH }}
          GOOGLE_GENAI_USE_VERTEXAI: ${{ secrets.GOOGLE_GENAI_USE_VERTEXAI }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}

      - name: Upload Playwright Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: ./src/material_ai/ui/playwright-report/
          retention-days: 5

      # 2. NEW: Comment the link on the PR
      - name: Comment Report Link on PR
        uses: actions/github-script@v7
        # Only run on PRs (not pushes to main) and run even if tests failed
        if: always() && github.event_name == 'pull_request'
        with:
          script: |
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo